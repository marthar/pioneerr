<!DOCTYPE html>
<html>
  <head>
    <title>Trashy Fish</title>
    <meta name="description" content="trashy fish">
    <script src="https://aframe.io/releases/0.9.0/aframe.min.js"></script>
    <style>
      #videoElement {
        width:100%;
        height:100%;
        object-fit: cover;
        opacity:0.5;
        position:absolute;
      }

      .cover {
        width:100%;
        height:100%;
        opacity:0.5;
        position:absolute;
        background-color:#06c1b0;
      }
    </style>

  </head>
    <body style="margin : 0px; overflow: hidden;">
    <video playsinline autoplay loop muted id="videoElement"></video>
    <div class='cover'></div>
    <a-scene id='sceneElement' gltf-model="dracoDecoderPath: draco_decoder.js;" background="transparent:true" fog="type: exponential; density: 0.03; color: #06c1b0; near:0; ">

      <a-assets>
         <a-asset-item id="fish1-obj"  src="assets/fish2/Mesh_Fish.obj"></a-asset-item>
         <a-asset-item id="fish2-obj"  src="assets/fish5/fish.obj"></a-asset-item>
         <a-asset-item id="fish3-obj"  src="assets/fish2/Mesh_Fish.obj"></a-asset-item>
          <a-asset-item id="fish4-obj"  src="assets/fish1/Mesh_Goldfish.obj"></a-asset-item>
         <a-asset-item id="trash1-obj" src="assets/bag/bag.obj"></a-asset-item>
         <a-asset-item id="trash2-obj" src="assets/blobthree/ProjectName.obj"></a-asset-item>
         <a-asset-item id="trash3-obj" src="assets/cup/cup.obj"></a-asset-item>
         <a-asset-item id="trash4-obj" src="assets/sqiuggle/trash.obj"></a-asset-item> 
         <a-asset-item id="trash5-obj" src="assets/soda-rings/soda-rings.obj"></a-asset-item> 
      </a-assets>
    
    </a-scene>
  </body>
    
    <script>
      //document.getElementById("angel").addEventListener("model-error",function(e) { console.log(e); })

      var video = document.querySelector("#videoElement");

      if(navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video:  { facingMode: "environment" }})
        .then(function (stream) {
          video.srcObject = stream;
        })
        .catch(function (error) {
          console.log("Something went wrong!");
        });
      }


      var REVERSE_CHANCE = 0.5; // 0.5 == 50%;
      var TRASH_SET = 0.1 // 0.2 == 20%


      var SETS = 40; // Total number of sets to create sets are circling and movement
      var FISH_COUNT = 150; // Total number of things to create


      function createFishSet() {
         var fishSetWrapper = document.createElement("a-entity")
         var fishSet = document.createElement("a-entity")

         var rotateStart = rnd(0,360)
         var length = rnd(20000,60000)
         var delay=rnd(0,3000)

         var reverse = Math.random() < REVERSE_CHANCE;
         var trash = Math.random() < TRASH_SET;

         fishSet.setAttribute("data-reverse",reverse ? 'true' : 'false')
         fishSet.setAttribute("data-trash",trash ? 'true' : 'false')

         fishSet.setAttribute('rotation','0 ${rotateStart} 0')
         fishSet.setAttribute('animation',
          `property: rotation; loop:true; from: 0 ${rotateStart} 0; to: 0 ${rotateStart+(reverse ? -360 : 360)} 0; delay: ${delay}; dur: ${length}; loop:true; easing: easeInOutQuad;`)

         var wiggle = rnd(0,5)
         var wiggleDur= rnd(5000,10000)

         fishSetWrapper.setAttribute('animation',
          `property: rotation; from: 0 0 0; to: ${wiggle} 0 0; loop: true; dur: ${wiggleDur}; dir: alternate; easing: easeInOutSine;`)

         fishSetWrapper.appendChild(fishSet)
         document.getElementById("sceneElement").appendChild(fishSetWrapper)

         return fishSet;
      }

      var fishSets = [];

      var fishList = [
        { model: "obj: #fish1-obj", scale: .03, textures: [ 'fish-skin1.png' ] },
        { model: "obj: #fish2-obj", scale: 1, textures: [ 'fish-skin2.png', 'fish-skin1.png'   ]  },
        { model: "obj: #fish3-obj", scale: .03, textures: [ 'fish-skin3.jpg' ]  },
        { model: "obj: #fish4-obj", scale: .03, textures: [ 'fish-skin3.jpg'   ]  }
      ]

      var trashList = [
        { model: "obj: #trash1-obj", scale: 0.02, textures: [ 'trash.jpg' ]  },
        { model: "obj: #trash2-obj", scale: 0.02, textures: [ 'trash2.png', 'trash.jpg']  },
        { model: "obj: #trash3-obj", scale: 0.02, textures: [ 'trash2.png' ]  },  
        { model: "obj: #trash4-obj", scale: 1, textures: [ 'trash3.jpg' ]  },
        { model: "obj: #trash5-obj", scale: 0.02, textures: [ 'trash.jpg' ]  }
      ]


      function createFish() {
         var newEl = document.createElement("a-entity")

         var fishSetIdx = Math.floor(rnd(0,fishSets.length));
         var fishSet = fishSets[fishSetIdx];


         var isTrash = fishSet.getAttribute('data-trash') == 'true' 

         var objList = fishList
         if(isTrash) { 
            objList = trashList;
         }

         var fish = objList[Math.floor(rnd(0,objList.length))]

         newEl.setAttribute('obj-model', fish.model)


         var randomScale = 1; // rnd(0.6,1.2 ) // how small, how big
         var randomPosX = rnd(-10,10)  // wide in front of you
         var randomPosY = rnd(-15,15)  // high in front of you
         var randomPosZ = rnd(-25, -5) // close to far from you

         var rotateStart = rnd(-80,-90)  // fish wiggle
         var rotateEnd= rnd(-100,-90) // end wiggle
         var length=rnd(500,1500)  // wiggle length

         if(fishSet.getAttribute('data-reverse') == 'true') { 
            rotateStart = -rotateStart;
            rotateEnd =-rotateEnd;
         }   // this makes reverse fish point in the right direction

         rotateStart = `0 ${rotateStart} 0`
         rotateEnd = `0 ${rotateEnd} 0`

         if(isTrash) {
           rotateStart = rnd(0,360)
           rotateEnd = rotateStart + 360;
           rotateStart = `${rotateStart} ${rotateStart} ${rotateStart}`
           rotateEnd = `${rotateEnd} ${rotateEnd} ${rotateEnd}`
           length=rnd(10000,20000)
         }  // tumbling trash

         var delay = rnd(0,600)  // fish wiggle wait
         
         var scale = fish.scale;
          
         // Pick a random texture from the list
         var texture = fish.textures[Math.floor(rnd(0,fish.textures.length))];

         newEl.setAttribute('scale',`${scale} ${scale} ${scale}`)
         newEl.setAttribute('position', `${randomPosX} ${randomPosY} ${randomPosZ}`)
         newEl.setAttribute('material', `src: assets/skins/${texture};`)
         newEl.setAttribute('rotation', `0 90 0`)
         newEl.setAttribute('animation',`property: rotation; loop:true; from: ${rotateStart}; to:${rotateEnd}; delay: ${delay}; dur: ${length}; dir: ${isTrash ? 'normal' : 'alternate'}; easing: easeInOutSine;`)

        fishSet.appendChild(newEl)
      }


      window.addEventListener("load", function() {
        for(var i = 0;i < SETS;i++) {
          fishSets.push(createFishSet())
        }

        for(var j=0;j<FISH_COUNT;j++) {
          createFish()
        }
      })

      function rnd(min, max) {
        return Math.random() * (max - min) + min;
      }

    
    </script>
</html>
